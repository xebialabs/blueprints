{{$app := .ClusterName | kebabcase}}
apiVersion: xl-release/v1
kind: Templates
spec:
- name: {{$app}}
  type: xlrelease.Folder
  children:
  - name: "{{$app}}-ci-cd"
    type: xlrelease.Release
    description: |
      This XL Release template shows how to deploy an EKS cluster using XL Deploy.
    tags:
    - AWS
    - EKS
    - "{{$app}}"
    scriptUsername: !value XL_RELEASE_USERNAME
    scriptUserPassword: !value XL_RELEASE_PASSWORD

    variables:
    - key: control
      type: xlrelease.MapStringStringVariable
      requiresValue: false
      showOnReleaseStart: false
      value:
        namespace: "{{.Namespace}}"
        serviceName: nginx

    - key: lbHostnameOrIp
      type: xlrelease.StringVariable
      requiresValue: false
      showOnReleaseStart: false

    - key: xld-admin-password
      type: xlrelease.PasswordStringVariable
      requiresValue: true
      showOnReleaseStart: false
      value: !value XL_DEPLOY_PASSWORD

    - type: xlrelease.StringVariable
      key: eksEndpoint
      requiresValue: false
      showOnReleaseStart: false
    - type: xlrelease.StringVariable
      key: eksClusterName
      requiresValue: false
      showOnReleaseStart: false

    phases:
    # Provision Infra
    - name: Provision Infrastructure
      color: '#ff9e3b'
      type: xlrelease.Phase
      tasks:
      - name: Provision Lambda artifacts
        type: xlrelease.SequentialGroup
        tasks:
        - name: Create S3 bucket for lambda artifacts
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-LAMBDA/{{$app}}-lambda-bucket/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
        - name: Upload lambda artifacts to S3
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-LAMBDA/{{$app}}-lambda-artifacts/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
      - name: Provision AWS VPC and IAM resources
        type: xlrelease.ParallelGroup
        tasks:
        - name: Provision AWS IAM resources
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-CLOUDFORMATION/{{$app}}-cloudformation-eks-user/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
        - name: Provision AWS VPC
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-CLOUDFORMATION/{{$app}}-cloudformation-eks-vpc/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
      - name: Provision AWS EKS cluster
        type: xlrelease.SequentialGroup
        tasks:
        - name: Provision EKS master node
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-CLOUDFORMATION/{{$app}}-cloudformation-eks-master/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
        - name: Tag namespace
          type: xld.UpdateCIProperty
          server: XL Deploy
          ciID: Infrastructure/{{$app}}/{{$app}}-master-EKSCluster/{{.Namespace}}
          ciProperty: tags
          propertyValue: '[ "{{.NamespaceTag}}" ]'
        - name: Provision EKS workers nodes
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-CLOUDFORMATION/{{$app}}-cloudformation-eks-workers/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
        - name: Update workers dictionary for kube-system environment
          type: xld.UpdateCIProperty
          server: XL Deploy
          ciID: Environments/{{$app}}/{{$app}}-master-EKSCluster-kube-system
          ciProperty: dictionaries
          propertyValue: '[ "Environments/{{$app}}/{{$app}}-eks-workers-dictionary" ]'
        - name: Provision EKS config map for workers
          type: xldeploy.Deploy
          server: XL Deploy
          deploymentPackage: "{{$app}}/EKS-CLOUDFORMATION/{{$app}}-k8s-configmap/1.0.0"
          deploymentEnvironment: Environments/{{$app}}/{{$app}}-master-EKSCluster-kube-system

    - name: Deploy Application
      type: xlrelease.Phase
      tasks:

      - name: Deploy node
        type: xldeploy.Deploy
        server: XL Deploy
        deploymentPackage: nginx/latest
        deploymentEnvironment: Environments/{{$app}}/aws-cloudformation-{{$app}}
        tags:
        - {{.NamespaceTag}}

    - name: Test
      type: xlrelease.Phase
      tasks:

      - name: Get service public URL
        type: xlrelease.SequentialGroup
        tasks:

        - name: Wait 120 seconds for load balancer to be ready
          type: xlrelease.ScriptTask
          script: |
            import time
            time.sleep(120)

        - name: Get K8s service specs
          type: xldeploy.Controltask
          server: XL Deploy
          numberOfContinueRetrials: 100
          pollingInterval: 10
          ciId: Infrastructure/{{$app}}/{{$app}}-master-EKSCluster
          taskName: describeService
          variableMapping:
            pythonScript.xlDeployTaskId: ${taskId}
            pythonScript.parameters: ${control}

        - name: Parse Store K8s service
          type: webhook.XmlWebhook
          URL: "{{.XLDUrlForXLR}}/deployit/tasks/v2/export"
          method: GET
          username: !value XL_DEPLOY_USERNAME
          xPathExpression: "/list/task[@id=\"${taskId}\"]//log/text()"
          variableMapping:
            pythonScript.result: ${taskOutput}
            pythonScript.password: ${xld-admin-password}

        - name: Get K8s service ip or hostname
          type: xlrelease.ScriptTask
          script: |
            import re
            m = re.search('hostname:(.*)\nip:([0-9.]+|None)', releaseVariables['taskOutput'])
            ipHostname = [m.group(1), m.group(2)]
            for item in ipHostname:
                if 'None' not in item:
                    releaseVariables['lbHostnameOrIp'] = item

      - name: Check application status
        type: xlrelease.ScriptTask
        script: |
          import urllib2
          import time
          time.sleep(60)
          req = urllib2.Request('http://${lbHostnameOrIp}')
          opener = urllib2.build_opener()
          response = opener.open(req)
          body = response.read()
          if 'Welcome to nginx' in body:
              print 'All instances are running'
          else:
              print 'Not all instances are running'
              exit(1)

      - name: Verify application
        type: xlrelease.GateTask
        team: Release Admin
        description: |
          The app is now live!
          Check out the website and complete this task when done.

          URL => http://${lbHostnameOrIp}
---

apiVersion: xl-release/v1
kind: Templates
spec:
- name: "{{$app}}"
  type: xlrelease.Folder
  children:
  - name: "{{$app}}-destroy"
    type: xlrelease.Release
    description: |
      This XL Release template shows how to de-provision an AWS EKS cluster using XL Deploy.
    tags:
    - AWS
    - EKS
    - "{{$app}}"
    scriptUsername: !value XL_RELEASE_USERNAME
    scriptUserPassword: !value XL_RELEASE_PASSWORD
    phases:
    - name: Undeploy Application
      type: xlrelease.Phase
      tasks:
      - name: Undeploy node
        type: xldeploy.Undeploy
        server: XL Deploy
        deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/nginx

    - name: Deprovision Infrastructure
      color: '#ff9e3b'
      type: xlrelease.Phase
      tasks:
      - name: Deprovision AWS EKS cluster
        type: xlrelease.SequentialGroup
        tasks:
        - name: Deprovision EKS config map for workers
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/{{$app}}-master-EKSCluster-kube-system/{{$app}}-k8s-configmap
        - name: Update workers dictionary for kube-system environment
          type: xld.UpdateCIProperty
          server: XL Deploy
          ciID: Environments/{{$app}}/{{$app}}-master-EKSCluster-kube-system
          ciProperty: dictionaries
          propertyValue: '[]'
        - name: Deprovision EKS workers nodes
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-cloudformation-eks-workers
        - name: Deprovision EKS master node
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-cloudformation-eks-master
      - name: Delete artifacts from S3
        type: xlrelease.SequentialGroup
        tasks:
        - name: Delete artifacts from S3
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-lambda-artifacts
        - name: Delete S3 bucket
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-lambda-bucket
      - name: Deprovision AWS VPC and IAM resources
        type: xlrelease.SequentialGroup
        tasks:
        - name: Deprovision AWS IAM resources
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-cloudformation-eks-user
        - name: Deprovision AWS VPC
          type: xldeploy.Undeploy
          server: XL Deploy
          deployedApplication: Environments/{{$app}}/aws-cloudformation-{{$app}}/{{$app}}-cloudformation-eks-vpc
